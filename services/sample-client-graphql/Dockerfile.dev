# BASE
FROM node:22-alpine AS base

RUN apk --no-cache add \
      bash \
      g++ \
      ca-certificates \
      lz4-dev \
      musl-dev \
      cyrus-sasl-dev \
      openssl \
      make \
      python3 \
      libc6-compat

RUN apk add --no-cache --virtual .build-deps gcc zlib-dev libc-dev bsd-compat-headers py-setuptools bash

RUN npm install -g turbo

# BUILDER
FROM base AS builder

WORKDIR /var/web/

COPY . .
RUN turbo prune --scope=sample-client-graphql --docker

# INSTALLER
# Add lockfile and package.json's of isolated subworkspace
FROM base AS installer

WORKDIR /var/web

# First install the dependencies (as they change less often)
COPY .gitignore .gitignore
COPY --from=builder /var/web/out/json/ .
COPY --from=builder /var/web/out/package-lock.json .
RUN npm install

# Build the project
COPY --from=builder /var/web/out/full/ .
COPY turbo.json turbo.json

RUN turbo run build --filter=sample-client-graphql

# RUNNER
FROM base AS runner

WORKDIR /var/web

# Don't run production as root
RUN addgroup --system --gid 1001 nodes && adduser --system --uid 1001 nodejs
USER nodejs

COPY --from=installer --chown=nodejs:nodes /var/web .